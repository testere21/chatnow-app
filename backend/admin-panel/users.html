<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanıcı Yönetimi - Admin Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>👥</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>👥 Kullanıcı Yönetimi</h2>
            <div class="user-info">
                <span id="adminUsername"></span>
                <button class="btn btn-logout" id="logoutBtn">Çıkış</button>
            </div>
        </div>

        <div class="content">
            <div class="nav-tabs">
                <a href="/admin" class="tab">💎 Paketler</a>
                <a href="/admin/users.html" class="tab active">👥 Kullanıcılar</a>
                <a href="/admin/messages.html" class="tab">💬 Mesajlar</a>
                <a href="/admin/reports.html" class="tab">⚠️ Şikayetler</a>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Kullanıcı ara (isim veya email)...">
                <select id="userTypeFilter" class="user-type-filter">
                    <option value="">Tüm Kullanıcılar</option>
                    <option value="normal">Normal Kayıt</option>
                    <option value="manual">Manuel Eklenen</option>
                </select>
                <button class="btn btn-success" id="addBotBtn">+ Destek Botu Ekle</button>
                <button class="btn btn-success" id="runProfileBotBtn">🤖 Profil Botu</button>
                <button class="btn btn-danger" id="bulkDeleteBtn" style="display: none;">Seçilenleri Sil</button>
            </div>
            
            <div class="bot-section">
                <h3>Destek Botları</h3>
                <div id="botList" class="bot-list"></div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox"></th>
                        <th>Avatar</th>
                        <th class="sortable-header" data-sort="name">İsim <span class="sort-arrow">↕</span></th>
                        <th class="sortable-header" data-sort="email">Email <span class="sort-arrow">↕</span></th>
                        <th>Şifre</th>
                        <th class="sortable-header" data-sort="diamonds">Jeton <span class="sort-arrow">↕</span></th>
                        <th class="sortable-header" data-sort="is_online">Durum <span class="sort-arrow">↕</span></th>
                        <th class="sortable-header" data-sort="created_at">Kayıt Tarihi <span class="sort-arrow">↕</span></th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="8" class="empty-state">Yükleniyor...</td></tr>
                </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <div class="pagination-info">
                    <span id="paginationInfo">Sayfa 1 / 1</span>
                </div>
                <div class="pagination-buttons">
                    <button id="prevPageBtn" class="btn btn-secondary" disabled>← Önceki</button>
                    <input type="number" id="pageJumpInput" class="page-jump-input" placeholder="Sayfa" min="1" max="1">
                    <button id="jumpToPageBtn" class="btn btn-primary">Git</button>
                    <button id="nextPageBtn" class="btn btn-secondary" disabled>Sonraki →</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Bot Modal -->
    <div id="profileBotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🤖 Toplu Profil Güncelleme Botu</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:10px; color:#555;">Sadece email adına göre eşleştirir. Dosya adları <code>email.jpg|jpeg|png|webp</code> formatında olmalıdır.</p>
                <input type="file" id="profileFilesInput" accept="image/*" multiple />
                <div id="botStatus" style="margin-top:12px; font-size:14px; color:#374151;"></div>
                <div id="botLog" style="margin-top:8px; max-height:220px; overflow:auto; background:#f9fafb; border:1px solid #e5e7eb; padding:8px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="closeProfileBotBtn">Kapat</button>
                <button type="button" class="btn btn-success" id="startProfileBotBtn">Başlat</button>
            </div>
        </div>
    </div>

    <!-- Bot Modal -->
    <div id="botModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Destek Botu Ekle</h3>
            </div>
            <form id="botForm">
                <div class="input-group">
                    <label>Bot İsmi</label>
                    <input type="text" id="botName" required placeholder="Destek">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="botEmail" required placeholder="destek@chatnow.com">
                </div>
                <div class="input-group">
                    <label>Hakkında</label>
                    <textarea id="botAbout" rows="3" placeholder="Müşteri destek botu"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="closeBotModalBtn">İptal</button>
                    <button type="submit" class="btn btn-success">Oluştur</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>👤 Kullanıcı Düzenle</h3>
            </div>
            <form id="editForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>İsim *</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="input-group">
                        <label>Soyisim</label>
                        <input type="text" id="editSurname">
                    </div>
                    <div class="input-group">
                        <label>Yaş *</label>
                        <input type="number" id="editAge" required min="18" max="100">
                    </div>
                    <div class="input-group">
                        <label>Şehir *</label>
                        <input type="text" id="editLocation" required>
                    </div>
                    <div class="input-group">
                        <label>Jeton Miktarı</label>
                        <input type="number" id="editDiamonds" required min="0">
                    </div>
                    <div class="input-group">
                        <label>Profil Resmi</label>
                        <input type="url" id="editAvatar" placeholder="https://..." style="margin-bottom:8px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="file" id="avatarFile" accept="image/*">
                            <button type="button" class="btn btn-primary" id="uploadAvatarBtn">Yükle</button>
                            <span id="uploadStatus" style="font-size:12px; color:#666;"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Hakkında</label>
                    <textarea id="editAbout" rows="3" placeholder="Kullanıcı hakkında..."></textarea>
                </div>
                <div class="input-group">
                    <label>Hobiler (virgülle ayır)</label>
                    <input type="text" id="editHobbies" placeholder="Müzik, Spor, Sinema">
                    <small style="color: #999; font-size: 12px;">Örnek: Müzik, Spor, Sinema</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="closeEditModalBtn">İptal</button>
                    <button type="submit" class="btn btn-success">💾 Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('adminToken');
        let editingUserId = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentSearch = '';
        let currentUserType = '';
        let currentSortBy = '';
        let currentSortOrder = 'desc';

        if (!authToken) {
            window.location.href = '/admin';
        }

        document.getElementById('adminUsername').textContent = localStorage.getItem('adminUsername') || 'Admin';

        // Load users with pagination
        async function loadUsers(search = '', page = 1, userType = '', sortBy = '', sortOrder = 'desc') {
            try {
                let url = `${API_URL}/api/admin/users?page=${page}&limit=20`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                    currentSearch = search;
                } else {
                    currentSearch = '';
                }
                
                if (userType) {
                    url += `&user_type=${userType}`;
                    currentUserType = userType;
                } else {
                    currentUserType = '';
                }
                
                if (sortBy) {
                    url += `&sort_by=${sortBy}&sort_order=${sortOrder}`;
                    currentSortBy = sortBy;
                    currentSortOrder = sortOrder;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Kullanıcılar yüklenemedi');
                }

                const data = await response.json();
                renderUsers(data.users);
                updatePagination(data.pagination);
                updateSortArrows();
            } catch (error) {
                console.error(error);
                document.getElementById('usersBody').innerHTML = `
                    <tr><td colspan="8" class="empty-state">Hata: ${error.message}</td></tr>
                `;
            }
        }

        // Update pagination controls
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.totalPages;
            
            const paginationControls = document.getElementById('paginationControls');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageJumpInput = document.getElementById('pageJumpInput');
            
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                paginationInfo.textContent = `Sayfa ${currentPage} / ${totalPages} (Toplam: ${pagination.total} kullanıcı)`;
                
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
                
                // Update page jump input
                pageJumpInput.max = totalPages;
                pageJumpInput.value = currentPage;
            } else {
                paginationControls.style.display = 'none';
            }
        }

        // Load bots
        async function loadBots() {
            try {
                const response = await fetch(`${API_URL}/api/admin/support-bots`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const bots = await response.json();
                    displayBots(bots);
                }
            } catch (error) {
                console.error('Bot yükleme hatası:', error);
            }
        }

        // Display bots
        function displayBots(bots) {
            const botList = document.getElementById('botList');
            
            if (bots.length === 0) {
                botList.innerHTML = '<div class="empty-state">Henüz bot oluşturulmamış</div>';
                return;
            }

            botList.innerHTML = bots.map(bot => `
                <div class="bot-card">
                    <div class="bot-avatar">
                        <img src="${bot.avatar_image ? 
                            (bot.avatar_image.startsWith('data:') ? 
                                bot.avatar_image : 
                                bot.avatar_image.includes('/uploads/') ? 
                                    bot.avatar_image.replace('/uploads/', '/api/admin/thumbnail/') : 
                                    bot.avatar_image) : 
                            'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\".9em\" font-size=\"90\">🤖</text></svg>'}" 
                             alt="${bot.name}" class="bot-avatar-img">
                        <input type="file" id="botAvatar_${bot._id}" accept="image/*" style="display: none;">
                        <button class="btn btn-sm btn-primary" data-bot-id="${bot._id}">Resim Değiştir</button>
                    </div>
                    <div class="bot-info">
                        <h4>${bot.name}</h4>
                        <p>${bot.email}</p>
                        <p>${bot.about || 'Bot açıklaması yok'}</p>
                    </div>
                </div>
            `).join('');

            // Bot resmi değiştirme event listener'ları
            bots.forEach(bot => {
                const fileInput = document.getElementById(`botAvatar_${bot._id}`);
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await updateBotAvatar(bot._id, file);
                    }
                });
            });
        }

        // Update bot avatar
        async function updateBotAvatar(botId, file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_URL}/api/admin/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Bot'un avatar'ını güncelle
                    const updateResponse = await fetch(`${API_URL}/api/admin/users/${botId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            avatar: data.imageUrl
                        })
                    });

                    if (updateResponse.ok) {
                        alert('Bot resmi güncellendi!');
                        loadBots(); // Bot listesini yenile
                        loadUsers(); // Kullanıcı listesini de yenile (bot'lar da görünür)
                    } else {
                        alert('Bot resmi güncellenemedi');
                    }
                } else {
                    alert('Resim yüklenemedi');
                }
            } catch (error) {
                console.error('Bot resmi güncelleme hatası:', error);
                alert('Hata oluştu');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Kullanıcı bulunamadı</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <input type="checkbox" class="user-checkbox" data-id="${user._id}" data-name="${user.name}">
                    </td>
                    <td>
                        ${user.avatar_image ? 
                            `<img src="${user.avatar_image.startsWith('data:') ? 
                                user.avatar_image : 
                                user.avatar_image.includes('/uploads/') ? 
                                    user.avatar_image.replace('/uploads/', '/api/admin/thumbnail/') : 
                                    user.avatar_image}" 
                                  style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                  class="user-avatar-img"
                                  loading="lazy">` :
                            `<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${user.gender === 'male' ? '👨' : '👩'}
                             </div>`
                        }
                    </td>
                    <td><strong>${user.name} ${user.surname || ''}</strong></td>
                    <td>${user.email}</td>
                    <td style="font-family: monospace; color: #666;">${user.password || '-'}</td>
                    <td><strong>${user.diamonds || 0}</strong> 💎</td>
                    <td>
                        <span class="status-badge ${user.is_online ? 'status-active' : 'status-inactive'}">
                            ${user.is_online ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                    <td>
                        <button class="btn btn-primary btn-small edit-user-btn" data-id="${user._id}" data-diamonds="${user.diamonds}">
                            Düzenle
                        </button>
                        <button class="btn btn-danger btn-small delete-user-btn" data-id="${user._id}" data-name="${user.name}">
                            Sil
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadUsers(e.target.value, 1, currentUserType); // Reset to page 1 when searching
            }, 300);
        });

        // Pagination button events
        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadUsers(currentSearch, currentPage - 1, currentUserType);
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadUsers(currentSearch, currentPage + 1, currentUserType);
            }
        });

        // User type filter event
        document.getElementById('userTypeFilter').addEventListener('change', (e) => {
            loadUsers(currentSearch, 1, e.target.value); // Reset to page 1 when filtering
        });

        // Page jump functionality
        document.getElementById('jumpToPageBtn').addEventListener('click', () => {
            const pageInput = document.getElementById('pageJumpInput');
            const targetPage = parseInt(pageInput.value);
            
            if (targetPage >= 1 && targetPage <= totalPages) {
                loadUsers(currentSearch, targetPage, currentUserType);
            } else {
                alert(`Geçersiz sayfa numarası! 1-${totalPages} arasında bir sayı girin.`);
            }
        });

        // Page jump input enter key
        document.getElementById('pageJumpInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('jumpToPageBtn').click();
            }
        });

        // Bot Modal
        document.getElementById('addBotBtn').addEventListener('click', () => {
            document.getElementById('botModal').style.display = 'flex';
        });

        document.getElementById('closeBotModalBtn').addEventListener('click', () => {
            document.getElementById('botModal').style.display = 'none';
        });

        document.getElementById('botForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const botData = {
                name: document.getElementById('botName').value,
                email: document.getElementById('botEmail').value,
                about: document.getElementById('botAbout').value
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/support-bots`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(botData)
                });

                if (response.ok) {
                    document.getElementById('botModal').style.display = 'none';
                    document.getElementById('botForm').reset();
                    loadUsers();
                    alert('Bot oluşturuldu!');
                } else {
                    const data = await response.json();
                    alert(data.error || 'Bot oluşturulamadı');
                }
            } catch (error) {
                alert('Hata oluştu');
            }
        });

        // Edit User
        document.getElementById('usersBody').addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-user-btn')) {
                editingUserId = e.target.getAttribute('data-id');
                
                try {
                    // Fetch full user data
                    const response = await fetch(`${API_URL}/api/admin/users/${editingUserId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        
                        // Fill form
                        document.getElementById('editName').value = user.name || '';
                        document.getElementById('editSurname').value = user.surname || '';
                        document.getElementById('editAge').value = user.age || 18;
                        document.getElementById('editLocation').value = user.location || '';
                        document.getElementById('editDiamonds').value = user.diamonds || 0;
                        document.getElementById('editAvatar').value = user.avatar || '';
                        document.getElementById('editAbout').value = user.about || '';
                        document.getElementById('editHobbies').value = Array.isArray(user.hobbies) ? user.hobbies.join(', ') : '';
                        
                        document.getElementById('editModal').style.display = 'flex';
                    } else {
                        alert('Kullanıcı bilgileri yüklenemedi');
                    }
                } catch (error) {
                    alert('Hata oluştu');
                }
            }
        });

        document.getElementById('closeEditModalBtn').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const hobbiesText = document.getElementById('editHobbies').value;
            const hobbies = hobbiesText ? hobbiesText.split(',').map(h => h.trim()).filter(h => h) : [];

            const userData = {
                name: document.getElementById('editName').value,
                surname: document.getElementById('editSurname').value,
                age: parseInt(document.getElementById('editAge').value),
                location: document.getElementById('editLocation').value,
                diamonds: parseInt(document.getElementById('editDiamonds').value),
                avatar: document.getElementById('editAvatar').value,
                about: document.getElementById('editAbout').value,
                hobbies: hobbies
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    document.getElementById('editModal').style.display = 'none';
                    loadUsers();
                    alert('✅ Kullanıcı başarıyla güncellendi!');
                } else {
                    const data = await response.json();
                    alert('❌ Güncelleme başarısız: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('❌ Hata oluştu: ' + error.message);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', logout);

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            window.location.href = '/admin';
        }

        // Upload avatar
        document.getElementById('uploadAvatarBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('avatarFile');
            const statusEl = document.getElementById('uploadStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Lütfen bir resim seçin');
                return;
            }

            const file = fileInput.files[0];
            
            // Resim boyutunu kontrol et (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                alert('Resim çok büyük! Maksimum 2MB olmalı.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            statusEl.textContent = 'Yükleniyor...';

            try {
                const response = await fetch(`${API_URL}/api/admin/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('editAvatar').value = data.url;
                    statusEl.textContent = 'Yüklendi!';
                } else {
                    statusEl.textContent = 'Hata: ' + (data.error || 'Yüklenemedi');
                }
            } catch (error) {
                statusEl.textContent = 'Hata: ' + error.message;
            }
        });

        // -------- PROFILE BOT (email-only) --------
        function botLog(line){
            const el = document.getElementById('botLog');
            el.textContent += `${line}\n`;
            el.scrollTop = el.scrollHeight;
        }

        function normalizeEmailFileName(email){
            return [
                `${email}.jpg`, `${email}.jpeg`, `${email}.png`, `${email}.webp`,
                `${email.toLowerCase()}.jpg`, `${email.toLowerCase()}.jpeg`, `${email.toLowerCase()}.png`, `${email.toLowerCase()}.webp`
            ];
        }

        async function fetchAllUsersForBot(){
            // Büyük limit ile tüm kullanıcıları çekmeye çalış
            const url = `${API_URL}/api/admin/users?page=1&limit=10000`;
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` } });
            if (!res.ok) throw new Error('Kullanıcı listesi alınamadı');
            const data = await res.json();
            return data.users || [];
        }

        async function uploadImageForBot(file){
            const form = new FormData();
            form.append('file', file, file.name);
            const res = await fetch(`${API_URL}/api/admin/upload`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: form
            });
            const data = await res.json();
            if (!res.ok || !data.url) throw new Error(data.error || data.message || 'Yükleme hatası');
            return data.url;
        }

        async function updateUserAvatar(userId, url){
            const res = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ avatar: url, avatar_image: url })
            });
            if (!res.ok) {
                const data = await res.json().catch(()=>({}));
                throw new Error(data.error || 'Profil güncellenemedi');
            }
        }

        document.getElementById('runProfileBotBtn').addEventListener('click', () => {
            document.getElementById('profileBotModal').style.display = 'flex';
            document.getElementById('botStatus').textContent = '';
            document.getElementById('botLog').textContent = '';
            const f = document.getElementById('profileFilesInput');
            if (f) f.value = '';
        });
        document.getElementById('closeProfileBotBtn').addEventListener('click', () => {
            document.getElementById('profileBotModal').style.display = 'none';
        });

        document.getElementById('startProfileBotBtn').addEventListener('click', async () => {
            const filesInput = document.getElementById('profileFilesInput');
            const files = Array.from(filesInput.files || []);
            if (files.length === 0){
                alert('Lütfen en az bir resim seç.');
                return;
            }

            document.getElementById('botStatus').textContent = 'Kullanıcılar çekiliyor...';
            botLog('Kullanıcılar çekiliyor...');
            let users = [];
            try {
                users = await fetchAllUsersForBot();
            } catch(e){
                botLog('❌ ' + e.message);
                document.getElementById('botStatus').textContent = 'Hata';
                return;
            }
            botLog(`Toplam kullanıcı: ${users.length}`);

            const fileMap = new Map();
            files.forEach(f => fileMap.set(f.name, f));

            let ok=0, skip=0, fail=0, i=0;
            for (const u of users){
                i++;
                const variants = normalizeEmailFileName(u.email || '');
                const fname = variants.find(n => fileMap.has(n));
                if (!fname){ skip++; continue; }
                const file = fileMap.get(fname);
                try {
                    document.getElementById('botStatus').textContent = `Yükleniyor (${i}/${users.length}): ${u.email}`;
                    const url = await uploadImageForBot(file);
                    await updateUserAvatar(u._id || u.id, url);
                    botLog(`✅ ${u.email} -> ${fname}`);
                    ok++;
                    await new Promise(r=>setTimeout(r,300));
                } catch(e){
                    botLog(`❌ ${u.email} -> ${e.message}`);
                    fail++;
                }
            }
            document.getElementById('botStatus').textContent = `Bitti. Başarılı: ${ok}, Atlanan: ${skip}, Hata: ${fail}`;
        });

        // Resim hata event listener'ları - sonsuz döngüyü önle
        document.addEventListener('error', (e) => {
            if (e.target.classList.contains('bot-avatar-img')) {
                // Sadece bir kez fallback yap
                if (!e.target.dataset.fallbackApplied) {
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🤖</text></svg>';
                    e.target.dataset.fallbackApplied = 'true';
                }
            } else if (e.target.classList.contains('user-avatar-img')) {
                // Sadece bir kez fallback yap
                if (!e.target.dataset.fallbackApplied) {
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">👤</text></svg>';
                    e.target.dataset.fallbackApplied = 'true';
                }
            }
        }, true);

        // Bot resim değiştirme event listener'ları
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-bot-id]')) {
                const botId = e.target.getAttribute('data-bot-id');
                const fileInput = document.getElementById(`botAvatar_${botId}`);
                if (fileInput) {
                    fileInput.click();
                }
            }
        });

        // Delete user functionality
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.getAttribute('data-id');
                const userName = e.target.getAttribute('data-name');
                
                if (confirm(`"${userName}" kullanıcısını silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz ve kullanıcının tüm mesajları, sohbetleri ve engellemeleri silinecektir.`)) {
                    try {
                        const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        
                        if (response.ok) {
                            alert('Kullanıcı başarıyla silindi');
                            loadUsers(currentSearch, currentPage, currentUserType); // Reload current page
                        } else {
                            const error = await response.json();
                            alert(`Hata: ${error.error}`);
                        }
                    } catch (error) {
                        console.error('Delete user error:', error);
                        alert('Kullanıcı silinirken hata oluştu');
                    }
                }
            }
        });

        // Bulk operations
        document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkDeleteButton();
        });

        // Individual checkbox change
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('user-checkbox')) {
                updateBulkDeleteButton();
                updateSelectAllCheckbox();
            }
        });

        // Update bulk delete button visibility
        function updateBulkDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            
            if (checkedBoxes.length > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                bulkDeleteBtn.textContent = `Seçilenleri Sil (${checkedBoxes.length})`;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
        }

        // Update select all checkbox
        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // Bulk delete functionality
        document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const userIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));
            const userNames = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-name'));
            
            if (confirm(`${userNames.length} kullanıcıyı silmek istediğinizden emin misiniz?\n\nSeçilen kullanıcılar: ${userNames.join(', ')}\n\nBu işlem geri alınamaz!`)) {
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const userId of userIds) {
                        try {
                            const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            
                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    
                    alert(`Toplu silme tamamlandı!\nBaşarılı: ${successCount}\nHatalı: ${errorCount}`);
                    loadUsers(currentSearch, currentPage, currentUserType); // Reload current page
                } catch (error) {
                    console.error('Bulk delete error:', error);
                    alert('Toplu silme işleminde hata oluştu');
                }
            }
        });

        // Update sort arrows
        function updateSortArrows() {
            const headers = document.querySelectorAll('.sortable-header');
            headers.forEach(header => {
                const arrow = header.querySelector('.sort-arrow');
                const sortBy = header.getAttribute('data-sort');
                
                if (sortBy === currentSortBy) {
                    arrow.textContent = currentSortOrder === 'asc' ? '↑' : '↓';
                    arrow.style.color = '#3b82f6';
                } else {
                    arrow.textContent = '↕';
                    arrow.style.color = '#6b7280';
                }
            });
        }

        // Sort functionality
        document.addEventListener('click', (e) => {
            if (e.target.closest('.sortable-header')) {
                const header = e.target.closest('.sortable-header');
                const sortBy = header.getAttribute('data-sort');
                let newSortOrder = 'asc';
                
                if (sortBy === currentSortBy) {
                    newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                }
                
                loadUsers(currentSearch, 1, currentUserType, sortBy, newSortOrder);
            }
        });

        // Load on start
        loadUsers();
        loadBots();
    </script>
</body>
</html>

